<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Insert title here</title>
	<style>
		.a { border: solid red 5px; }
		span { width: 150px; color: red; }
		input { border: solid gray 1px; }
		table { width: 100%; border-collapse: collapse; }
		th, td { border: 1px gray solid; text-align: center; padding: 3px; }
		h2 { text-align: center; }
		a { text-decoration: none; }
		a:hover { color: red; }
	</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

	<script type="text/javascript">
		$(function() {
			/*
              1) 전체검색
              - 서버로부터 고객 리스트 데이터를 가져와 테이블에 출력
            */
			$.ajax({
				url: "/ajax?key=customer&methodName=selectAll",
				type: "get",
				dataType: "json",
				success: function(result) {
					let str = "";
					$.each(result, function(index, user) {
						str += "<tr>";
						str += "<td>" + (index + 1) + "</td>";
						str += "<td>" + user.id + "</td>";
						str += "<td>" + user.name + "</td>";
						str += "<td>" + user.age + "</td>";
						str += "<td>" + user.tel + "</td>";
						str += "<td>" + user.addr + "</td>";
						str += "<td><button data-id='" + user.id + "' class='deleteBtn'>삭제</button></td>";
						str += "</tr>";
					});
					$("#listTable tbody").html(str);
				},
				error: function() {
					alert("전체검색 중 오류가 발생했습니다.");
				}
			});

			/*
              2) 아이디중복체크
            */
			$(document).on("blur","#id",function(){
				const userId=$(this).val();

				if(userId!=="")
				{
					$.ajax({
						url: "/ajax?key=customer&methodName=idCheck",
						type: "get",
						data:{id:userId},
						success:function(result){
							if(result==="중복")
							{
								$("span").text("중복된 아이디입니다");
							}
							else
							{
								$("span").text("사용 가능한 아이디입니다");
							}
						}
					})
				}
			})

			/**
			 3) 가입하기 또는 수정하기

			 */
			$(document).on("click", "#btn", function() {
				$.ajax({
					url: "/ajax?key=customer&methodName=insert",
					type: "post",
					data: $("#inForm").serialize(), // 폼 데이터를 직렬화하여 서버로 전송
					success: function(result) {
						alert("가입 완료");
						reloadCustomerList(); // 가입 후 전체 목록을 다시 불러옴
					},
					error: function() {
						alert("가입 중 오류가 발생했습니다.");
					}
				});
			});

			/*
              4) 아이디를 클릭했을 때
              -
            */

			/*
              5) 삭제하기

            */
			$(document).on("click", ".deleteBtn", function() {
				const userId = $(this).data("id"); // 버튼에 저장된 사용자 id
				$.ajax({
					url: "/ajax?key=customer&methodName=delete",
					type: "get",
					data: { id: userId },
					success: function(result) {
						if(result==='1')
						{
							alert("삭제 완료");
							reloadCustomerList(); // 삭제 후 목록을 다시 불러옴. 이거 안 하면 삭제했는데 계속 목록에 남아있음
						}
						else
						{
							alert("삭제 중 오류a가 발생했습니다.");
						}

					},
					error: function() {
						alert("삭제 중 오류가 발생했습니다.");
					}
				});
			});

		}); // ready 끝

		// 고객 리스트 다시 불러오기 함수, 삭제를 했을 때 다시 리로드해야 한다
		function reloadCustomerList() {
			$.ajax({
				url: "/ajax?key=customer&methodName=selectAll",
				type: "get",
				dataType: "json",
				success: function(result) {
					let str = "";
					$.each(result, function(index, user) {
						str += "<tr>";
						str += "<td>" + (index + 1) + "</td>";
						str += "<td>" + user.id + "</td>";
						str += "<td>" + user.name + "</td>";
						str += "<td>" + user.age + "</td>";
						str += "<td>" + user.tel + "</td>";
						str += "<td>" + user.addr + "</td>";
						str += "<td><button data-id='" + user.id + "' class='deleteBtn'>삭제</button></td>";
						str += "</tr>";
					});
					$("#listTable tbody").html(str);
					// tbody 안에 데이터를 추가, tbody & thead 제대로 구분 안 하면 내용물 삭제했는데 thead 도 같이 없어지는 현상이 있음
				},
				error: function() {
					alert("전체검색 중 오류가 발생했습니다.");
				}
			});
		}

	</script>

</head>
<body>
<h2>회원정보 입력</h2>

<form name="inForm" method="post" id="inForm">
	<table>
		<tr bgcolor="pink">
			<th>아이디</th>
			<th>이름</th>
			<th>나이</th>
			<th>전화번호</th>
			<th>주소</th>
		</tr>
		<tr>
			<td style="text-align:left"><input type="text" size="8" name="id" id="id"> <span>중복결과여부</span></td>
			<td><input type="text" size="8" name="name" id="name"></td>
			<td><input type="text" size="4" name="age" id="age"></td>
			<td><input type="text" size="12" name="tel" id="tel"></td>
			<td><input type="text" size="30" name="addr" id="addr"></td>
		</tr>
		<tr>
			<td colspan="5" align="center">
				<input type="hidden" name="key" value="customer">
				<input type="hidden" name="methodName" value="insert">
				<input type="button" value="가입하기" id="btn">
			</td>
		</tr>
	</table>
</form>

<br>
<hr color="red">

<h2>고객 리스트 !</h2>
<table id="listTable">
	<thead>
	<tr bgcolor="pink">
		<th>번호</th>
		<th>아이디</th>
		<th>이름</th>
		<th>나이</th>
		<th>전화번호</th>
		<th>주소</th>
		<th>삭제</th>
	</tr>
	</thead>
	<tbody>
	<!-- 데이터 출력 -->
	</tbody>
</table>

</body>
</html>
